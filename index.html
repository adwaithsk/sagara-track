<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>SagaraTrack v3</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial,
        sans-serif;
      background-color: #f3f4f6;
    }
    .app-container {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
      background: white;
      position: relative;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
    }
    .btn-primary {
      background: linear-gradient(135deg, #ef4444, #f97316, #22c55e, #3b82f6);
      background-size: 300% 300%;
      animation: gradientMove 6s ease infinite;
      transition: transform 0.1s;
    }
    .btn-primary:active {
      transform: scale(0.98);
    }
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      border: 1px solid #e5e7eb;
      border-bottom: 3px solid #f97316;
    }
    @keyframes gradientMove {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
  </style>
</head>
<body class="text-gray-800">
<div class="app-container flex flex-col">

  <!-- HEADER -->
  <header
    class="bg-gradient-to-r from-red-500 via-orange-400 to-blue-500 text-white p-4 sticky top-0 z-50 flex justify-between items-center">
    <div>
      <h1 class="text-xl font-bold tracking-tight">
        Sagara<span class="font-extrabold">Track</span>
      </h1>
      <p class="text-xs opacity-80" id="current-date"></p>
      <p class="text-[11px] opacity-80">Submitted By: Adwaith SK</p>
    </div>
    <div
      id="user-status"
      class="h-9 w-9 rounded-full bg-white/20 border border-white/40 flex items-center justify-center text-xs">
      <i class="fas fa-user"></i>
    </div>
  </header>

  <!-- MAIN -->
  <main class="flex-grow p-4 space-y-4 overflow-y-auto pb-24" id="main-view">

    <!-- HOME -->
    <div id="view-home">
      <div class="card p-6 text-center space-y-4 mb-6">
        <div
          class="h-16 w-16 bg-gradient-to-br from-sky-500 via-blue-500 to-indigo-600 text-white rounded-full flex items-center justify-center mx-auto text-2xl shadow-lg">
          <i class="fas fa-fish"></i>
        </div>
        <h2 class="text-lg font-semibold">Ready for a new delivery?</h2>
        <p class="text-xs text-gray-500">
          Track stops, kilometres and expenses, then export a PDF like your written report.
        </p>
        <button onclick="app.startTripFlow()"
                class="btn-primary w-full py-3 rounded-xl text-white font-semibold shadow-lg mt-2">
          Start New Trip
        </button>
      </div>

      <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-2">
        Recent Trips
      </h3>
      <div id="recent-trips-list" class="space-y-3">
        <div
          class="p-4 bg-gray-50 border rounded-lg text-center text-gray-400 text-sm">
          No recent trips found
        </div>
      </div>
    </div>

    <!-- ACTIVE TRIP -->
    <div id="view-active-trip" class="hidden space-y-4">
      <!-- Trip header -->
      <div
        class="bg-gradient-to-r from-sky-500 via-blue-500 to-indigo-600 text-white p-4 rounded-xl shadow-lg relative overflow-hidden">
        <div class="relative z-10">
          <div class="flex justify-between items-start">
            <div>
              <p class="text-blue-100 text-xs uppercase font-bold">Current Trip</p>
              <h2 class="text-2xl font-bold mt-1" id="dash-timer">00:00</h2>
              <p class="text-[11px] text-blue-100" id="dash-duration-label">
                Running: 0h 0m
              </p>
              <p class="text-[11px] text-blue-100" id="dash-vehicle"></p>
            </div>
            <div class="text-right">
              <p class="text-blue-100 text-xs">Start Odo</p>
              <p class="font-mono font-bold" id="dash-odo-start">0 KM</p>
              <p class="text-blue-100 text-xs mt-1" id="dash-odo-end"></p>
            </div>
          </div>
        </div>
        <div class="absolute -right-6 -bottom-10 text-blue-300/40 text-9xl">
          <i class="fas fa-network-wired"></i>
        </div>
      </div>

      <!-- Active stop banner -->
      <div id="active-stop-banner"
           class="hidden bg-emerald-50 border border-emerald-200 text-emerald-800 px-3 py-2 rounded-lg flex items-center justify-between text-xs">
        <div>
          <div class="font-semibold flex items-center gap-1">
            <i class="fas fa-map-pin text-emerald-500"></i>
            <span id="active-stop-location">Active stop</span>
          </div>
          <div class="text-[11px]" id="active-stop-in-time"></div>
        </div>
        <button
          id="active-stop-out-btn"
          class="ml-3 px-3 py-1 rounded bg-emerald-600 text-white text-[11px] font-semibold"
          onclick="app.markActiveStopOut()">
          Mark OUT
        </button>
      </div>

      <!-- Actions -->
      <div class="grid grid-cols-3 gap-3">
        <button
          onclick="app.showLogStopModal()"
          class="bg-white p-3 rounded-xl border shadow-sm flex flex-col items-center justify-center gap-1 active:bg-gray-50">
          <div
            class="h-9 w-9 bg-green-100 text-green-600 rounded-full flex items-center justify-center">
            <i class="fas fa-map-marker-alt"></i>
          </div>
          <span class="font-medium text-xs text-center">Add Stop<br />(IN now)</span>
        </button>
        <button
          onclick="app.showExpenseModal()"
          class="bg-white p-3 rounded-xl border shadow-sm flex flex-col items-center justify-center gap-1 active:bg-gray-50">
          <div
            class="h-9 w-9 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center">
            <i class="fas fa-receipt"></i>
          </div>
          <span class="font-medium text-xs text-center">Add<br />Expense</span>
        </button>
        <button
          onclick="app.editTripDomainData()"
          class="bg-white p-3 rounded-xl border shadow-sm flex flex-col items-center justify-center gap-1 active:bg-gray-50">
          <div
            class="h-9 w-9 bg-sky-100 text-sky-600 rounded-full flex items-center justify-center">
            <i class="fas fa-pen"></i>
          </div>
          <span class="font-medium text-xs text-center">Cash &<br />Goods</span>
        </button>
      </div>

      <!-- Timeline -->
      <div>
        <h3
          class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-2">
          Trip Timeline
        </h3>
        <div
          id="trip-timeline"
          class="space-y-3 relative before:absolute before:inset-0 before:ml-5 before:-translate-x-px before:h-full before:w-0.5 before:bg-gradient-to-b before:from-transparent before:via-gray-300 before:to-transparent">
        </div>
      </div>

      <button
        onclick="app.showNotesPrompt()"
        class="w-full py-2 mb-1 bg-slate-100 text-slate-700 rounded-xl text-xs font-medium border">
        Edit Notes
      </button>

      <button
        onclick="app.endTripFlow()"
        class="w-full py-3 bg-gray-900 text-white rounded-xl font-semibold mt-1">
        End Trip & Generate PDF
      </button>
    </div>
  </main>

  <!-- START TRIP MODAL -->
  <div
    id="modal-start-trip"
    class="fixed inset-0 bg-black/50 z-50 hidden flex items-end sm:items-center justify-center p-4">
    <div class="bg-white w-full max-w-sm rounded-2xl p-6 space-y-4">
      <h3 class="text-lg font-bold">Start Trip</h3>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Start Odometer (KM)
        </label>
        <input
          type="number"
          id="input-start-odo"
          class="w-full p-3 border rounded-lg bg-gray-50 text-lg"
          placeholder="e.g. 7425" />
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Vehicle
        </label>
        <select
          id="input-vehicle"
          class="w-full p-3 border rounded-lg bg-gray-50"
          onchange="app.handleVehicleChange()">
          <option value="Suzuki Super Carry – PY 03 B 7569" selected>
            Suzuki Super Carry – PY 03 B 7569
          </option>
          <option value="other">Other…</option>
        </select>
      </div>

      <div id="other-vehicle-fields" class="hidden space-y-2">
        <input
          type="text"
          id="input-vehicle-name"
          class="w-full p-3 border rounded-lg bg-gray-50"
          placeholder="Vehicle name (e.g. Eicher)" />
        <input
          type="text"
          id="input-vehicle-number"
          class="w-full p-3 border rounded-lg bg-gray-50"
          placeholder="Number plate (e.g. KL 13 AB 1234)" />
      </div>

      <div class="flex gap-3 mt-4">
        <button
          onclick="app.closeModal('modal-start-trip')"
          class="flex-1 py-3 text-gray-600 font-medium">
          Cancel
        </button>
        <button
          onclick="app.confirmStartTrip()"
          class="flex-1 py-3 bg-blue-600 text-white rounded-lg font-semibold">
          Start
        </button>
      </div>
    </div>
  </div>

  <!-- LOG STOP MODAL -->
  <div
    id="modal-log-stop"
    class="fixed inset-0 bg-black/50 z-50 hidden flex items-end sm:items-center justify-center p-4">
    <div class="bg-white w-full max-w-sm rounded-2xl p-6 space-y-4">
      <h3 class="text-lg font-bold">Add Stop (IN now)</h3>
      <p class="text-xs text-gray-500">
        Time IN is set to the current time automatically. You can mark OUT later from the
        banner or timeline.
      </p>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Location / Customer
        </label>
        <input
          type="text"
          id="input-stop-location"
          class="w-full p-3 border rounded-lg bg-gray-50"
          placeholder="e.g. Vishalam" />
      </div>
      <div class="flex gap-3 mt-4">
        <button
          onclick="app.closeModal('modal-log-stop')"
          class="flex-1 py-3 text-gray-600 font-medium">
          Cancel
        </button>
        <button
          onclick="app.confirmLogStop()"
          class="flex-1 py-3 bg-green-600 text-white rounded-lg font-semibold">
          Save Stop
        </button>
      </div>
    </div>
  </div>

  <!-- EXPENSE MODAL -->
  <div
    id="modal-expense"
    class="fixed inset-0 bg-black/50 z-50 hidden flex items-end sm:items-center justify-center p-4">
    <div class="bg-white w-full max-w-sm rounded-2xl p-6 space-y-4">
      <h3 class="text-lg font-bold">Add Expense</h3>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Category
        </label>
        <select
          id="input-exp-category"
          class="w-full p-3 border rounded-lg bg-gray-50">
          <option value="Fuel">Fuel</option>
          <option value="Toll (FASTag)">Toll (FASTag)</option>
          <option value="Porter - KNR">Porter - KNR</option>
          <option value="Porter - TLY">Porter - TLY</option>
          <option value="Water">Water</option>
          <option value="Coconut Water">Coconut Water</option>
          <option value="Lunch">Lunch</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Amount (₹)
        </label>
        <input
          type="number"
          id="input-exp-amount"
          class="w-full p-3 border rounded-lg bg-gray-50 text-lg"
          placeholder="0" />
      </div>

      <div class="flex items-center gap-2 text-sm text-gray-600">
        <input type="checkbox" id="input-exp-personal" class="h-4 w-4" checked />
        <label for="input-exp-personal">Out-of-pocket (reimbursable)</label>
      </div>

      <div class="flex gap-3 mt-4">
        <button
          onclick="app.closeModal('modal-expense')"
          class="flex-1 py-3 text-gray-600 font-medium">
          Cancel
        </button>
        <button
          onclick="app.confirmExpense()"
          class="flex-1 py-3 bg-orange-600 text-white rounded-lg font-semibold">
          Save
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  const app = {
    state: {
      activeTrip: null,
      trips: [],
      notes: '',
      timerInterval: null,
      activeStopId: null
    },

    // INIT
    init() {
      const savedTrips = localStorage.getItem('sagara_trips_v3');
      const activeTrip = localStorage.getItem('sagara_active_trip_v3');
      const savedNotes = localStorage.getItem('sagara_notes_v3');

      if (savedTrips) this.state.trips = JSON.parse(savedTrips);
      if (activeTrip) this.state.activeTrip = JSON.parse(activeTrip);
      if (savedNotes) this.state.notes = savedNotes;

      document.getElementById('current-date').innerText =
        new Date().toLocaleDateString('en-IN', {
          weekday: 'short',
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });

      if (this.state.activeTrip) this.renderActiveTrip();
      else this.renderHome();
    },

    // VEHICLE
    handleVehicleChange() {
      const sel = document.getElementById('input-vehicle').value;
      const fields = document.getElementById('other-vehicle-fields');
      fields.classList.toggle('hidden', sel !== 'other');
    },

    // NAV
    renderHome() {
      document.getElementById('view-home').classList.remove('hidden');
      document.getElementById('view-active-trip').classList.add('hidden');
      this.stopTimer();
      this.renderRecentTrips();
    },

    renderActiveTrip() {
      document.getElementById('view-home').classList.add('hidden');
      document.getElementById('view-active-trip').classList.remove('hidden');

      const t = this.state.activeTrip;
      document.getElementById('dash-odo-start').innerText = t.odoStart + ' KM';
      document.getElementById('dash-odo-end').innerText = t.odoEnd
        ? 'End: ' + t.odoEnd + ' KM'
        : '';
      document.getElementById('dash-vehicle').innerText = t.vehicle;

      this.startTimer();
      this.updateActiveStopBanner();
      this.renderTimeline();
    },

    startTripFlow() {
      document.getElementById('input-start-odo').value = '';
      document.getElementById('input-vehicle').value =
        'Suzuki Super Carry – PY 03 B 7569';
      this.handleVehicleChange();
      document.getElementById('modal-start-trip').classList.remove('hidden');
    },

    confirmStartTrip() {
      const odoVal = document.getElementById('input-start-odo').value;
      let vehicleVal = document.getElementById('input-vehicle').value;

      if (!odoVal) return alert('Enter start odometer');

      if (vehicleVal === 'other') {
        const name = document.getElementById('input-vehicle-name').value.trim();
        const num = document
          .getElementById('input-vehicle-number')
          .value.trim();
        if (!name || !num) return alert('Enter vehicle name and number');
        vehicleVal = name + ' – ' + num;
      }

      this.state.activeTrip = {
        id: 'trip_' + Date.now(),
        date: new Date().toISOString(),
        vehicle: vehicleVal,
        odoStart: parseInt(odoVal),
        odoEnd: null,
        startTime: Date.now(),
        endTime: null,
        totalDist: 0,
        events: [],
        stops: [],
        expenses: [],
        cashCollected: 0,
        cashFrom: '',
        returns: '',
        undelivered: '',
        notes: this.state.notes || ''
      };

      this.saveState();
      this.closeModal('modal-start-trip');
      this.renderActiveTrip();
    },

    // TIMER
    startTimer() {
      if (this.state.timerInterval) clearInterval(this.state.timerInterval);
      this.updateTimerOnce();
      this.state.timerInterval = setInterval(
        () => this.updateTimerOnce(),
        60000
      );
    },

    stopTimer() {
      if (this.state.timerInterval) clearInterval(this.state.timerInterval);
      this.state.timerInterval = null;
    },

    updateTimerOnce() {
      const t = this.state.activeTrip;
      if (!t) return;
      const now = Date.now();
      const elapsedMs = now - t.startTime;
      const h = Math.floor(elapsedMs / 3600000);
      const m = Math.round((elapsedMs % 3600000) / 60000);
      const label =
        h.toString().padStart(2, '0') +
        ':' +
        m.toString().padStart(2, '0');
      document.getElementById('dash-timer').innerText = label;
      document.getElementById(
        'dash-duration-label'
      ).innerText = `Running: ${h}h ${m}m`;
    },

    // STOPS
    showLogStopModal() {
      document.getElementById('input-stop-location').value = '';
      document.getElementById('modal-log-stop').classList.remove('hidden');
    },

    confirmLogStop() {
      const loc = document
        .getElementById('input-stop-location')
        .value.trim();
      if (!loc) return alert('Enter location');

      const now = Date.now();
      const stop = {
        id: 'stop_' + now,
        type: 'stop',
        timestamp: now,
        location: loc,
        timeIn: now,
        timeOut: null
      };

      this.state.activeTrip.events.push(stop);
      this.state.activeTrip.stops.push(stop);
      this.saveState();
      this.closeModal('modal-log-stop');
      this.updateActiveStopBanner();
      this.renderTimeline();
    },

    markStopOut(stopId) {
      const trip = this.state.activeTrip;
      const now = Date.now();

      trip.stops.forEach(s => {
        if (s.id === stopId && !s.timeOut) s.timeOut = now;
      });
      trip.events.forEach(e => {
        if (e.id === stopId && !e.timeOut) e.timeOut = now;
      });

      this.saveState();
      this.updateActiveStopBanner();
      this.renderTimeline();
    },

    markActiveStopOut() {
      if (!this.state.activeStopId) return;
      this.markStopOut(this.state.activeStopId);
    },

    updateActiveStopBanner() {
      const banner = document.getElementById('active-stop-banner');
      const locEl = document.getElementById('active-stop-location');
      const inEl = document.getElementById('active-stop-in-time');

      const openStop =
        this.state.activeTrip &&
        this.state.activeTrip.stops.find(s => !s.timeOut);

      if (!openStop) {
        banner.classList.add('hidden');
        this.state.activeStopId = null;
        return;
      }

      this.state.activeStopId = openStop.id;
      banner.classList.remove('hidden');
      locEl.textContent = openStop.location;
      const inStr = new Date(openStop.timeIn).toLocaleTimeString([], {
        hour: '2-digit',
        minute: '2-digit'
      });
      inEl.textContent = `IN: ${inStr}`;
    },

    // EXPENSES
    showExpenseModal() {
      document.getElementById('input-exp-amount').value = '';
      document.getElementById('input-exp-personal').checked = true;
      document.getElementById('input-exp-category').value = 'Fuel';
      document.getElementById('modal-expense').classList.remove('hidden');
    },

    confirmExpense() {
      const amt = document.getElementById('input-exp-amount').value;
      const cat = document.getElementById('input-exp-category').value;
      const isPersonal =
        document.getElementById('input-exp-personal').checked;

      if (!amt) return alert('Enter amount');

      const now = Date.now();
      const exp = {
        id: 'exp_' + now,
        type: 'expense',
        timestamp: now,
        category: cat,
        amount: parseFloat(amt),
        isPersonal: isPersonal
      };

      this.state.activeTrip.events.push(exp);
      this.state.activeTrip.expenses.push(exp);
      this.saveState();
      this.closeModal('modal-expense');
      this.renderTimeline();
    },

    // CASH / RETURNS / UNDELIVERED
    editTripDomainData() {
      if (!this.state.activeTrip) return;
      const t = this.state.activeTrip;

      const cash = prompt(
        'Cash received (₹, leave 0 if none):',
        t.cashCollected || 0
      );
      if (cash === null) return;
      const from = prompt(
        'Cash received from (e.g. Fathima Nets / Shahul Hameed):',
        t.cashFrom || ''
      );
      if (from === null) return;
      const returns = prompt(
        'Returned items (twine/net details):',
        t.returns || ''
      );
      if (returns === null) return;
      const undelivered = prompt(
        'Undelivered items:',
        t.undelivered || ''
      );
      if (undelivered === null) return;

      t.cashCollected = parseFloat(cash) || 0;
      t.cashFrom = from;
      t.returns = returns;
      t.undelivered = undelivered;
      this.saveState();
    },

    // NOTES
    showNotesPrompt() {
      const text = prompt(
        'Notes (keys, where items kept, etc.):',
        this.state.notes || ''
      );
      if (text !== null) {
        this.state.notes = text;
        if (this.state.activeTrip) this.state.activeTrip.notes = text;
        this.saveState();
      }
    },

    // TIMELINE
    renderTimeline() {
      const container = document.getElementById('trip-timeline');
      container.innerHTML = '';

      const trip = this.state.activeTrip;
      if (!trip || trip.events.length === 0) {
        container.innerHTML =
          '<div class="text-center text-gray-400 py-4 text-sm">Trip started. Log your first stop or expense.</div>';
        return;
      }

      const events = [...trip.events].sort(
        (a, b) => a.timestamp - b.timestamp
      );

      events.forEach(ev => {
        const timeStr = new Date(ev.timestamp).toLocaleTimeString([], {
          hour: '2-digit',
          minute: '2-digit'
        });

        if (ev.type === 'stop') {
          const inStr = new Date(ev.timeIn).toLocaleTimeString([], {
            hour: '2-digit',
            minute: '2-digit'
          });
          const outStr =
            ev.timeOut &&
            new Date(ev.timeOut).toLocaleTimeString([], {
              hour: '2-digit',
              minute: '2-digit'
            });

          const isOpen = !ev.timeOut;

          const html = `
          <div class="relative flex items-start gap-3">
            <div
              class="absolute -left-[5px] mt-1.5 h-3 w-3 rounded-full border-2 border-white ${
                isOpen ? 'bg-green-500' : 'bg-gray-400'
              } shadow-sm z-10"></div>
            <div class="flex-1 bg-white p-3 rounded-lg border shadow-sm text-sm">
              <div class="flex justify-between">
                <span class="font-semibold text-gray-800">${ev.location}</span>
                <span class="text-gray-400 text-xs">${timeStr}</span>
              </div>
              <div class="text-xs text-gray-500 mt-1">
                IN: ${inStr} ${
            outStr ? `| OUT: ${outStr}` : '| OUT: —'
          }
              </div>
              ${
                isOpen
                  ? `<button class="mt-2 text-[11px] px-2 py-1 rounded bg-green-600 text-white"
                         onclick="app.markStopOut('${ev.id}')">
                       Mark OUT now
                     </button>`
                  : ''
              }
            </div>
          </div>`;
          container.insertAdjacentHTML('beforeend', html);
        } else if (ev.type === 'expense') {
          const html = `
          <div class="relative flex items-start gap-3">
            <div
              class="absolute -left-[5px] mt-1.5 h-3 w-3 rounded-full border-2 border-white bg-orange-500 shadow-sm z-10"></div>
            <div class="flex-1 bg-white p-3 rounded-lg border shadow-sm text-sm">
              <div class="flex justify-between font-semibold text-gray-800">
                <span>${ev.category}</span>
                <span class="text-red-600">- ₹${ev.amount.toFixed(2)}</span>
              </div>
              <div class="text-xs text-gray-400 mt-1">
                ${ev.isPersonal ? 'Out-of-pocket' : 'Company paid'} • ${timeStr}
              </div>
            </div>
          </div>`;
          container.insertAdjacentHTML('beforeend', html);
        }
      });
    },

    // END TRIP + PDF
    endTripFlow() {
      if (!this.state.activeTrip) return;
      const endOdo = prompt('Enter End Odometer Reading (KM):');
      if (!endOdo) return;

      const trip = this.state.activeTrip;
      trip.odoEnd = parseInt(endOdo);
      trip.endTime = Date.now();
      trip.totalDist = trip.odoEnd - trip.odoStart;

      this.state.trips.unshift(trip);
      this.generatePDF(trip);

      this.state.activeTrip = null;
      this.saveState();
      this.renderHome();
    },

    generatePDF(trip) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const dateStr = new Date(trip.startTime).toLocaleDateString('en-IN');

      // HEADER
      doc.setFontSize(16);
      doc.setTextColor(220, 53, 69);
      doc.text(
        'DELIVERY TRIP EXPENSE REPORT - SAGARA NETS',
        14,
        18
      );
      doc.setDrawColor(249, 115, 22);
      doc.setLineWidth(0.7);
      doc.line(14, 20, 196, 20);
      doc.setFontSize(10);
      doc.setTextColor(80);
      doc.text(`Report Date: ${dateStr}`, 14, 24);
      doc.text('Submitted By: Adwaith SK', 14, 29);

      // Trip details
      const tripBody = [
        ['Purpose', 'Delivery and Collection'],
        ['Date', dateStr],
        ['Vehicle', trip.vehicle],
        ['Odometer Start', trip.odoStart + ' km'],
        ['Odometer End', trip.odoEnd + ' km'],
        ['Total Distance', trip.totalDist + ' km']
      ];

      doc.autoTable({
        startY: 35,
        head: [['Trip Details', 'Values']],
        body: tripBody,
        theme: 'grid',
        headStyles: { fillColor: [59, 130, 246] }
      });

      // Route from stops
      const route =
        trip.stops.length > 0
          ? trip.stops.map(s => s.location).join(' -> ')
          : 'N/A';

      doc.autoTable({
        startY: doc.lastAutoTable.finalY + 4,
        body: [['Route', route]],
        theme: 'plain'
      });

      // Time tracking summary
      const startTimeStr = new Date(trip.startTime).toLocaleTimeString([], {
        hour: '2-digit',
        minute: '2-digit'
      });
      const endTimeStr = new Date(trip.endTime).toLocaleTimeString([], {
        hour: '2-digit',
        minute: '2-digit'
      });
      const durationMs = trip.endTime - trip.startTime;
      const durH = Math.floor(durationMs / 3600000);
      const durM = Math.round((durationMs % 3600000) / 60000);
      const durStr = `${durH}h ${durM}m`;

      doc.autoTable({
        startY: doc.lastAutoTable.finalY + 6,
        head: [['Time Tracking', '']],
        body: [
          ['Journey Start', startTimeStr],
          ['Journey End', endTimeStr],
          ['Total Duration', durStr]
        ],
        theme: 'grid',
        headStyles: { fillColor: [37, 99, 235] }
      });

      // Stops table
      const stopsRows = trip.stops.map((s, idx) => {
        const inT = new Date(s.timeIn).toLocaleTimeString([], {
          hour: '2-digit',
          minute: '2-digit'
        });
        const outT =
          s.timeOut &&
          new Date(s.timeOut).toLocaleTimeString([], {
            hour: '2-digit',
            minute: '2-digit'
          });
        return [idx + 1, s.location, inT, outT || '-'];
      });

      if (stopsRows.length > 0) {
        doc.autoTable({
          startY: doc.lastAutoTable.finalY + 8,
          head: [['#', 'Location', 'IN', 'OUT']],
          body: stopsRows,
          theme: 'striped',
          headStyles: { fillColor: [16, 185, 129] }
        });
      }

      // Expenses table
      const expenseRows = trip.expenses.map(e => [
        new Date(e.timestamp).toLocaleTimeString([], {
          hour: '2-digit',
          minute: '2-digit'
        }),
        e.category,
        e.isPersonal ? 'Out-of-pocket' : 'Company',
        e.amount.toFixed(2)
      ]);

      const totalExp = trip.expenses.reduce((a, b) => a + b.amount, 0);
      const reimbExp = trip.expenses
        .filter(e => e.isPersonal)
        .reduce((a, b) => a + b.amount, 0);
      const fastagTotal = trip.expenses
        .filter(e => e.category === 'Toll (FASTag)')
        .reduce((a, b) => a + b.amount, 0);

      if (expenseRows.length > 0) {
        doc.autoTable({
          startY: doc.lastAutoTable.finalY + 8,
          head: [['Time', 'Category', 'Payment', 'Amount (₹)']],
          body: expenseRows,
          theme: 'striped',
          headStyles: { fillColor: [249, 115, 22] }
        });
      }

      // Expense summary
      let sy = doc.lastAutoTable.finalY + 6;
      doc.setFontSize(11);
      doc.setTextColor(0);
      doc.text(`Total Trip Expenses: ₹${totalExp.toFixed(2)}`, 14, sy);
      doc.text(
        `Less Prepaid/FASTag: -₹${fastagTotal.toFixed(2)}`,
        14,
        sy + 6
      );
      doc.text(
        `Out-of-pocket Expenses (Reimbursable): ₹${reimbExp.toFixed(2)}`,
        14,
        sy + 12
      );
      doc.setFont(undefined, 'bold');
      doc.text(
        `FINAL REIMBURSEMENT DUE: ₹${reimbExp.toFixed(2)}`,
        14,
        sy + 18
      );
      doc.setFont(undefined, 'normal');

      // Cash / returns / undelivered
      let ny = sy + 26;
      if (trip.cashCollected || trip.returns || trip.undelivered) {
        doc.setFontSize(11);
        doc.text('Trip Collections & Goods:', 14, ny);
        doc.setFontSize(10);
        ny += 6;
        if (trip.cashCollected) {
          const line = `Cash received: ₹${trip.cashCollected.toFixed(2)}${
            trip.cashFrom ? ` from ${trip.cashFrom}` : ''
          }`;
          doc.text(line, 14, ny);
          ny += 5;
        }
        if (trip.returns) {
          doc.text(`Returned items: ${trip.returns}`, 14, ny);
          ny += 5;
        }
        if (trip.undelivered) {
          doc.text(`Undelivered items: ${trip.undelivered}`, 14, ny);
          ny += 5;
        }
      }

      // Notes
      const notesY = ny + 6;
      if (trip.notes && trip.notes.trim().length > 0) {
        doc.setFontSize(11);
        doc.text('Notes:', 14, notesY);
        doc.setFontSize(10);
        const split = doc.splitTextToSize(trip.notes, 180);
        doc.text(split, 14, notesY + 6);
      }

      doc.save(`Sagara_Trip_Report_${dateStr}.pdf`);
      alert('PDF report generated and downloaded.');
    },

    // RECENT TRIPS
    renderRecentTrips() {
      const list = document.getElementById('recent-trips-list');
      list.innerHTML = '';

      if (this.state.trips.length === 0) {
        list.innerHTML =
          '<div class="p-4 bg-gray-50 border rounded-lg text-center text-gray-400 text-sm">No recent trips</div>';
        return;
      }

      this.state.trips.slice(0, 5).forEach(trip => {
        const date = new Date(trip.startTime).toLocaleDateString('en-IN');
        const total = trip.expenses.reduce((a, b) => a + b.amount, 0);

        const html = `
        <div class="bg-white p-3 rounded-lg border shadow-sm flex justify-between items-center">
          <div>
            <div class="font-bold text-sm">${date}</div>
            <div class="text-xs text-gray-500">${trip.totalDist || 0} km • ${
          trip.vehicle
        }</div>
          </div>
          <div class="text-right">
            <div class="font-bold text-sm text-blue-600">₹${total.toFixed(
              2
            )}</div>
            <button class="text-xs text-green-600 mt-1"
                    onclick='app.generatePDF(${JSON.stringify(
                      trip
                    )})'>
              <i class="fas fa-file-pdf"></i> PDF
            </button>
          </div>
        </div>`;
        list.insertAdjacentHTML('beforeend', html);
      });
    },

    // SHARED
    closeModal(id) {
      document.getElementById(id).classList.add('hidden');
    },

    saveState() {
      localStorage.setItem(
        'sagara_trips_v3',
        JSON.stringify(this.state.trips)
      );
      if (this.state.activeTrip)
        localStorage.setItem(
          'sagara_active_trip_v3',
          JSON.stringify(this.state.activeTrip)
        );
      else localStorage.removeItem('sagara_active_trip_v3');

      localStorage.setItem('sagara_notes_v3', this.state.notes || '');
    }
  };

  app.init();
</script>
</body>
</html>
